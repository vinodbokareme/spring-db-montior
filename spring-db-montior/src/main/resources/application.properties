spring:
  application:
    name: spring-db-monitor

  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password:
    hikari:
      pool-name: orders-hikari-pool
      maximum-pool-size: 10
      minimum-idle: 5
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
      leak-detection-threshold: 60000

  jpa:
    show-sql: false
    hibernate:
      ddl-auto: create-drop
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
        generate_statistics: false
    open-in-view: false

  h2:
    console:
      enabled: true
      path: /h2-console

# Datasource Micrometer Configuration - All Features Enabled
datasource:
  micrometer:
    # Enable all observation types for comprehensive monitoring
    observeConnection: true      # Track connection lifecycle (acquire, commit, rollback)
    observeQuery: true           # Track query execution with SQL and parameters
    observeKeys: true            # Track generated keys from INSERT operations
    observeFetch: true           # Track ResultSet operations and row counts

    # Query logging configuration
    logQuery: true               # Enable query logging to SLF4J
    logQueryByLogger: true       # Use logger name based on connection
    queryLogLevel: DEBUG         # Log level for query logging
    slowQueryLogLevel: WARN      # Log level for slow queries
    slowQueryThreshold: 300      # Slow query threshold in milliseconds

    # Parameter and result logging
    includeParameterValues: true # Log bind parameter values for debugging
    queryLogFormat: JSON         # Format: JSON or MULTILINE

    # ResultSet tracking configuration
    resultSetProxyIncludeTimeToClose: true  # Include time until ResultSet is closed

    # Metrics configuration
    metricsEnabled: true         # Enable metrics collection
    exceptionAsMetricTag: true   # Include exception types as metric tags

    # DataSource name for meaningful service names
    dataSourceNameResolver:
      enabled: true
      defaultName: orders-db

management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,info,tracing,observations

  metrics:
    tags:
      application: ${spring.application.name}
      environment: development
      instance: local
    distribution:
      percentiles-histogram:
        jdbc.query: true
        jdbc.connection: true
        jdbc.connection.acquired: true
        jdbc.result-set: true
        jdbc.generated-keys: true
      percentiles:
        jdbc.query: 0.5, 0.75, 0.95, 0.99
        jdbc.connection: 0.5, 0.95, 0.99
    enable:
      jdbc: true
      hikaricp: true

  tracing:
    sampling:
      probability: 1.0  # Sample 100% for demo purposes
    propagation:
      type: b3

  observations:
    key-values:
      application: ${spring.application.name}

# Logging configuration for observability
logging:
  level:
    root: INFO
    com.translate_idea_2_code: DEBUG
    net.ttddyy.observation: DEBUG
    net.ttddyy.dsproxy: DEBUG
    org.springframework.jdbc: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    io.micrometer.observation: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
      jdbc.generated-keys: true
      percentiles:
        jdbc.query: 0.5,0.75,0.95,0.99
        jdbc.connection.acquired: 0.5,0.75,0.95,0.99
      slo:
        jdbc.query: 50ms,100ms,300ms,1s
        jdbc.connection.acquired: 100ms,500ms,1s
    enable:
      jdbc: true
      jvm: true
      process: true
      system: true

  tracing:
    sampling:
      probability: 1.0
    enabled: true

  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans

  observations:
    key-values:
      application: spring-db-monitor

jdbc:
  datasource-proxy:
    query:
      enable-logging: true
      log-level: debug
    slow-query:
      enable-logging: true
      threshold: 300
      log-level: warn
    multiline: true
    json-format: false

datasource:
  micrometer:
    observation:
      enabled: true
      connection: true
      query: true
      result-set: true
      fetch: true
      generated-keys: true
      bind-parameter: true
      include-parameter-values: false

logging:
  level:
    root: INFO
    com.translate_idea_2_code: DEBUG
    net.ttddyy.observation: DEBUG
    net.ttddyy.dsproxy: DEBUG
    io.micrometer: INFO
    io.micrometer.observation: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.springframework.jdbc: DEBUG
    com.zaxxer.hikari: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{traceId:-},%X{spanId:-}] %logger{50} - %msg%n"

server:
  port: 8080
  error:
    include-message: always
    include-stacktrace: on_param
